{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Advanced Analytics: UK Indicator Shocks and Distribution",
    "subtitle": "Histogram + density of YoY changes and σ-based shock detection over time (data: graphs/dashboard1.json)",
    "anchor": "start",
    "fontSize": 16,
    "subtitleFontSize": 12
  },
  "data": {
    "url": "graphs/dashboard1.json",
    "format": { "type": "json" }
  },
  "params": [
    {
      "name": "decade_select",
      "value": "All",
      "bind": {
        "input": "select",
        "options": ["All", "2000s", "2010s", "2020s"],
        "name": "Decade: "
      }
    },
    {
      "name": "bin_count",
      "value": 24,
      "bind": {
        "input": "range",
        "min": 10,
        "max": 45,
        "step": 1,
        "name": "Histogram bins: "
      }
    },
    {
      "name": "show_density",
      "value": true,
      "bind": { "input": "checkbox", "name": "Show density curve " }
    },
    {
      "name": "sigma_threshold",
      "value": 2.0,
      "bind": {
        "input": "range",
        "min": 1.0,
        "max": 4.0,
        "step": 0.25,
        "name": "Shock threshold (σ): "
      }
    }
  ],
  "transform": [
    { "calculate": "toNumber(datum.date)", "as": "year" },
    { "calculate": "toDate(toString(datum.year) + '-01-01')", "as": "year_date" },
    {
      "calculate": "datum.year < 2010 ? '2000s' : datum.year < 2020 ? '2010s' : '2020s'",
      "as": "decade"
    },
    { "filter": "isValid(datum.value) && datum.value != null && isValid(datum.year)" },
    { "filter": "decade_select == 'All' || datum.decade == decade_select" },
    {
      "window": [{ "op": "lag", "field": "value", "as": "prev_value" }],
      "sort": [{ "field": "year", "order": "ascending" }]
    },
    {
      "calculate": "isValid(datum.prev_value) && datum.prev_value != 0 ? (datum.value / datum.prev_value - 1) * 100 : null",
      "as": "yoy_pct"
    },
    { "filter": "datum.yoy_pct != null" },
    {
      "joinaggregate": [
        { "op": "mean", "field": "yoy_pct", "as": "mu" },
        { "op": "stdev", "field": "yoy_pct", "as": "sd" }
      ]
    },
    {
      "calculate": "datum.sd > 0 ? (datum.yoy_pct - datum.mu) / datum.sd : 0",
      "as": "z"
    },
    { "calculate": "abs(datum.z) >= sigma_threshold", "as": "is_shock" }
  ],
  "vconcat": [
    {
      "title": {
        "text": "A) Distribution of year-on-year changes",
        "anchor": "start",
        "fontSize": 13,
        "offset": 8
      },
      "layer": [
        {
          "mark": { "type": "bar", "opacity": 0.8, "cornerRadius": 3 },
          "encoding": {
            "x": {
              "field": "yoy_pct",
              "type": "quantitative",
              "bin": { "maxbins": { "expr": "bin_count" } },
              "title": "YoY change (%)",
              "axis": { "labelAngle": 0, "gridOpacity": 0.25 }
            },
            "y": {
              "aggregate": "count",
              "type": "quantitative",
              "title": "Frequency",
              "axis": { "gridOpacity": 0.25 }
            },
            "color": {
              "condition": { "test": "datum.is_shock", "value": "#ef4444" },
              "value": "#2563eb"
            },
            "tooltip": [
              { "aggregate": "count", "title": "Count" },
              { "field": "yoy_pct", "type": "quantitative", "title": "Bin Range", "bin": true }
            ]
          }
        },
        {
          "transform": [
            { "filter": "show_density" },
            { "density": "yoy_pct", "bandwidth": 0.8, "as": ["x", "density"] }
          ],
          "mark": { "type": "line", "strokeWidth": 2.5, "color": "#111827" },
          "encoding": {
            "x": { "field": "x", "type": "quantitative" },
            "y": {
              "field": "density",
              "type": "quantitative",
              "title": "Density",
              "axis": { "orient": "right", "grid": false }
            }
          }
        }
      ],
      "resolve": { "scale": { "y": "independent" } },
      "width": 600,
      "height": 250
    },
    {
      "title": {
        "text": "B) Shock analysis over time (z-score thresholding)",
        "anchor": "start",
        "fontSize": 13,
        "offset": 8
      },
      "layer": [
        {
          "transform": [
            { "calculate": "datum.mu + sigma_threshold * datum.sd", "as": "upper_band" },
            { "calculate": "datum.mu - sigma_threshold * datum.sd", "as": "lower_band" }
          ],
          "layer": [
            {
              "mark": { "type": "rule", "strokeWidth": 1, "color": "#cbd5e1", "strokeDash": [4, 2] },
              "encoding": { "y": { "field": "upper_band", "type": "quantitative" } }
            },
            {
              "mark": { "type": "rule", "strokeWidth": 1, "color": "#cbd5e1", "strokeDash": [4, 2] },
              "encoding": { "y": { "field": "lower_band", "type": "quantitative" } }
            }
          ]
        },
        {
          "mark": { "type": "line", "strokeWidth": 2, "color": "#2563eb" },
          "encoding": {
            "x": { "field": "year_date", "type": "temporal", "title": "Year" },
            "y": { "field": "yoy_pct", "type": "quantitative", "title": "YoY change (%)" }
          }
        },
        {
          "transform": [{ "filter": "datum.is_shock" }],
          "mark": { "type": "point", "filled": true, "size": 80, "color": "#ef4444" },
          "encoding": {
            "x": { "field": "year_date", "type": "temporal" },
            "y": { "field": "yoy_pct", "type": "quantitative" },
            "tooltip": [
              { "field": "year", "title": "Year" },
              { "field": "yoy_pct", "title": "Change", "format": ".2f" },
              { "field": "z", "title": "σ Shock Level", "format": ".2f" }
            ]
          }
        }
      ],
      "width": 600,
      "height": 250
    }
  ],
  "config": {
    "view": { "stroke": "transparent" },
    "axis": { "gridColor": "#e2e8f0" }
  }
}