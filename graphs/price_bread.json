{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Bread prices as an indexed lollipop + bubble chart (distinct from the beer chart).",
  "data": {
    "url": "data/price_bread.csv",
    "format": { "type": "csv" }
  },
  "transform": [
    { "calculate": "toDate(datum.dateISO)", "as": "date" },
    { "calculate": "toNumber(datum.price)", "as": "price_num" },

    {
      "joinaggregate": [
        { "op": "min", "field": "date", "as": "minDate" },
        { "op": "max", "field": "date", "as": "maxDate" }
      ]
    },
    {
      "joinaggregate": [{ "op": "mean", "field": "price_num", "as": "startPrice" }],
      "groupby": ["minDate"]
    },
    {
      "joinaggregate": [{ "op": "mean", "field": "price_num", "as": "endPrice" }],
      "groupby": ["maxDate"]
    },
    { "calculate": "(datum.endPrice - datum.startPrice)", "as": "deltaAbs" },
    { "calculate": "(datum.deltaAbs / datum.startPrice)", "as": "deltaPct" },

    { "calculate": "(datum.price_num / datum.startPrice) * 100", "as": "index_100" },

    {
      "window": [{ "op": "mean", "field": "index_100", "as": "ma3_index" }],
      "frame": [-2, 0],
      "sort": [{ "field": "date", "order": "ascending" }]
    }
  ],
  "title": {
    "text": "Six bread rolls price (white/brown)",
    "subtitle": {
      "expr": "timeFormat(datum.minDate,'%b %Y') + ' → ' + timeFormat(datum.maxDate,'%b %Y') + ' | ' + format(datum.startPrice,'.3f') + ' → ' + format(datum.endPrice,'.3f') + ' (' + (datum.deltaAbs>=0?'+':'') + format(datum.deltaAbs,'.3f') + ', ' + (datum.deltaPct>=0?'+':'') + format(datum.deltaPct*100,'.1f') + '%) | Index (start=100)'"
    },
    "anchor": "start",
    "fontSize": 18,
    "subtitleFontSize": 12,
    "offset": 12
  },
  "width": "container",
  "height": 360,
  "padding": { "top": 8, "right": 18, "bottom": 10, "left": 10 },

  "layer": [
    {
      "mark": { "type": "rule", "opacity": 0.8 },
      "encoding": {
        "x": {
          "field": "date",
          "type": "temporal",
          "title": null,
          "axis": {
            "format": "%Y",
            "labelAngle": 0,
            "tickCount": { "interval": "year", "step": 1 },
            "grid": false
          }
        },
        "y": { "value": 100 },
        "y2": { "field": "index_100", "type": "quantitative" },
        "color": { "value": "#D9A86C" }
      }
    },

    {
      "mark": { "type": "point", "filled": true, "opacity": 0.95 },
      "encoding": {
        "x": { "field": "date", "type": "temporal" },
        "y": { "field": "index_100", "type": "quantitative" },
        "size": {
          "field": "index_100",
          "type": "quantitative",
          "legend": null,
          "scale": { "range": [40, 350] }
        },
        "color": { "value": "#8C4A2F" },
        "tooltip": [
          { "field": "item_name", "type": "nominal", "title": "Item" },
          { "field": "date", "type": "temporal", "title": "Month", "format": "%b %Y" },
          { "field": "price_num", "type": "quantitative", "title": "Price", "format": ".4f" },
          { "field": "index_100", "type": "quantitative", "title": "Index (start=100)", "format": ".1f" }
        ]
      }
    },

    {
      "mark": { "type": "line", "interpolate": "monotone", "strokeWidth": 2.2 },
      "encoding": {
        "x": { "field": "date", "type": "temporal" },
        "y": { "field": "ma3_index", "type": "quantitative" },
        "color": { "value": "#D9A86C" }
      }
    },

    {
      "params": [
        {
          "name": "hover",
          "select": {
            "type": "point",
            "fields": ["date"],
            "nearest": true,
            "on": "mousemove",
            "clear": "mouseout"
          }
        }
      ],
      "mark": { "type": "point", "filled": true, "size": 85 },
      "encoding": {
        "x": { "field": "date", "type": "temporal" },
        "y": { "field": "index_100", "type": "quantitative" },
        "opacity": { "condition": { "param": "hover", "value": 1 }, "value": 0 },
        "color": { "value": "#8C4A2F" }
      }
    },

    {
      "transform": [{ "filter": { "param": "hover" } }],
      "mark": { "type": "rule" },
      "encoding": {
        "x": { "field": "date", "type": "temporal" },
        "color": { "value": "#B8B8B8" },
        "opacity": { "value": 0.9 }
      }
    }
  ],

  "encoding": {
    "y": {
      "field": "index_100",
      "type": "quantitative",
      "title": null,
      "axis": {
        "format": ".0f",
        "grid": true,
        "gridOpacity": 0.14,
        "tickCount": 6
      }
    }
  },

  "config": {
    "background": "transparent",
    "view": { "stroke": "transparent" },
    "axis": {
      "labelFontSize": 12,
      "titleFontSize": 12,
      "labelColor": "#2b2b2b",
      "domainColor": "#d8d8d8",
      "tickColor": "#d8d8d8"
    }
  }
}
