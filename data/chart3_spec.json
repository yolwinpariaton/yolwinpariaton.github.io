{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Regional cost of living choropleth across the UK (NUTS1-style regions)",

  "autosize": { "type": "fit", "contains": "padding" },

  "signals": [
    { "name": "width", "update": "containerSize()[0]" },
    { "name": "height", "update": "containerSize()[1]" }
  ],

  "padding": { "top": 10, "left": 10, "right": 10, "bottom": 10 },
  "background": "transparent",

  "title": {
    "text": "Regional Cost Variations Across UK",
    "subtitle": "Cost of living index and affordability by region",
    "anchor": "start",
    "fontSize": 14,
    "subtitleFontSize": 12
  },

  "data": [
    {
      "name": "regions",
      "url": "uk_regions.geojson",
      "format": { "type": "geojson" }
    },
    {
      "name": "econ",
      "url": "chart3_regional_detailed.json",
      "format": { "type": "json" }
    },
    {
      "name": "regions_joined",
      "source": "regions",
      "transform": [
        {
          "type": "formula",
          "as": "code",
          "expr": "datum.properties && (datum.properties.NUTS112CD || datum.properties.nuts112cd || datum.properties.ITL121CD || datum.properties.itl121cd || datum.properties.CODE || datum.properties.code)"
        },
        {
          "type": "formula",
          "as": "boundary_name",
          "expr": "datum.properties && (datum.properties.NUTS112NM || datum.properties.nuts112nm || datum.properties.ITL121NM || datum.properties.itl121nm || datum.properties.NAME || datum.properties.name)"
        },
        {
          "type": "lookup",
          "from": "econ",
          "key": "code",
          "fields": ["code"],
          "values": [
            "region",
            "cost_index",
            "rent_to_income",
            "energy_burden",
            "food_inflation",
            "population",
            "lat",
            "lon"
          ],
          "as": [
            "region",
            "cost_index",
            "rent_to_income",
            "energy_burden",
            "food_inflation",
            "population",
            "lat",
            "lon"
          ]
        },
        {
          "type": "formula",
          "as": "population_m",
          "expr": "datum.population ? datum.population / 1000000 : null"
        }
      ]
    },
    {
      "name": "econ_points",
      "source": "econ",
      "transform": [
        { "type": "formula", "as": "population_m", "expr": "datum.population / 1000000" },
        {
          "type": "geopoint",
          "projection": "ukproj",
          "fields": ["lon", "lat"],
          "as": ["x", "y"]
        }
      ]
    }
  ],

  "projections": [
    {
      "name": "ukproj",
      "type": "mercator",
      "fit": { "data": "regions", "field": "geometry" },
      "size": [{ "signal": "width" }, { "signal": "height" }]
    }
  ],

  "scales": [
    {
      "name": "colorScale",
      "type": "linear",
      "domain": { "data": "econ", "field": "cost_index" },
      "range": { "scheme": "reds" },
      "nice": true,
      "zero": false
    },
    {
      "name": "sizeScale",
      "type": "sqrt",
      "domain": { "data": "econ", "field": "population" },
      "range": [80, 900],
      "zero": true
    }
  ],

  "legends": [
    {
      "fill": "colorScale",
      "title": "Cost Index",
      "orient": "right",
      "gradientLength": 170,
      "titleFontSize": 12,
      "labelFontSize": 11
    },
    {
      "size": "sizeScale",
      "title": "Population",
      "orient": "right",
      "symbolType": "circle",
      "titleFontSize": 12,
      "labelFontSize": 11
    }
  ],

  "marks": [
    {
      "type": "shape",
      "from": { "data": "regions_joined" },
      "transform": [
        { "type": "geoshape", "projection": "ukproj", "field": "geometry" }
      ],
      "encode": {
        "enter": {
          "stroke": { "value": "#ffffff" },
          "strokeWidth": { "value": 1 }
        },
        "update": {
          "fill": [
            {
              "test": "isValid(datum.cost_index) && datum.cost_index != null",
              "scale": "colorScale",
              "field": "cost_index"
            },
            { "value": "#eef2ff" }
          ],
          "tooltip": {
            "signal": "{'Region': datum.region || datum.boundary_name, 'Code': datum.code, 'Boundary name': datum.boundary_name, 'Cost index': datum.cost_index, 'Population (m)': datum.population_m, 'Rent/Income (%)': datum.rent_to_income, 'Energy burden (%)': datum.energy_burden, 'Food inflation (%)': datum.food_inflation}"
          }
        }
      }
    },

    {
      "type": "shape",
      "from": { "data": "regions" },
      "transform": [
        { "type": "geoshape", "projection": "ukproj", "field": "geometry" }
      ],
      "encode": {
        "enter": {
          "fill": { "value": "transparent" },
          "stroke": { "value": "#111827" },
          "strokeWidth": { "value": 1 }
        }
      }
    },

    {
      "type": "symbol",
      "from": { "data": "econ_points" },
      "encode": {
        "enter": {
          "fill": { "value": "#111827" },
          "stroke": { "value": "#ffffff" },
          "strokeWidth": { "value": 1.1 },
          "opacity": { "value": 0.55 }
        },
        "update": {
          "x": { "field": "x" },
          "y": { "field": "y" },
          "size": { "scale": "sizeScale", "field": "population" },
          "tooltip": {
            "signal": "{'Region': datum.region, 'Code': datum.code, 'Cost index': datum.cost_index, 'Population': datum.population}"
          }
        }
      }
    }
  ],

  "config": {
    "view": { "stroke": "transparent" }
  }
}
